import React, { useState, useEffect } from 'react';
import { Check, ChevronDown, ChevronRight, Plus, Trash2, Home, Eye, EyeOff } from 'lucide-react';

const encouragingMessages = [
  "You're doing great!", "Amazing work!", "Keep it up!", "You're on fire!",
  "Fantastic job!", "You're crushing it!", "Way to go!", "Stellar work!",
  "You're unstoppable!", "Brilliant!", "You're a star!", "Phenomenal!",
  "Keep shining!", "You've got this!", "Superb effort!", "You're amazing!",
  "Outstanding!", "You're making magic happen!", "Wonderful progress!",
  "You're doing beautifully!", "Excellent work!", "You're incredible!",
  "Marvelous!", "You're on a roll!", "Splendid job!", "You're thriving!",
  "Impressive!", "You're glowing!", "Magnificent!", "You're blooming!",
  "Fabulous!", "You're flourishing!", "Radiant work!", "You're succeeding!",
  "Delightful!", "You're achieving greatness!", "Graceful progress!",
  "You're empowered!", "Lovely work!", "You're on the right path!",
  "Beautiful effort!", "You're growing stronger!", "Charming work!",
  "You're mastering this!", "Elegant progress!", "You're winning!"
];

const TodoApp = () => {
  const [lists, setLists] = useState([]);
  const [currentListId, setCurrentListId] = useState(null);
  const [showCompleted, setShowCompleted] = useState(true);
  const [celebration, setCelebration] = useState(null);
  const [newListName, setNewListName] = useState('');

  useEffect(() => {
    const saved = localStorage.getItem('catherineTodoLists');
    if (saved) {
      const parsed = JSON.parse(saved);
      setLists(parsed);
      if (parsed.length > 0 && !currentListId) {
        setCurrentListId(parsed[0].id);
      }
    }
  }, []);

  useEffect(() => {
    if (lists.length > 0) {
      localStorage.setItem('catherineTodoLists', JSON.stringify(lists));
    }
  }, [lists]);

  const createList = () => {
    if (!newListName.trim()) return;
    const newList = {
      id: Date.now(),
      name: newListName,
      tasks: []
    };
    setLists([...lists, newList]);
    setCurrentListId(newList.id);
    setNewListName('');
  };

  const deleteList = (listId) => {
    const updated = lists.filter(l => l.id !== listId);
    setLists(updated);
    if (currentListId === listId) {
      setCurrentListId(updated.length > 0 ? updated[0].id : null);
    }
  };

  const showCelebration = () => {
    const message = encouragingMessages[Math.floor(Math.random() * encouragingMessages.length)];
    setCelebration(message);
    setTimeout(() => setCelebration(null), 2000);
  };

  const getCurrentList = () => lists.find(l => l.id === currentListId);

  const updateCurrentList = (updatedTasks) => {
    setLists(lists.map(l => 
      l.id === currentListId ? { ...l, tasks: updatedTasks } : l
    ));
  };

  const addTask = (parentPath = []) => {
    const list = getCurrentList();
    if (!list) return;

    const newTask = {
      id: Date.now(),
      text: '',
      completed: false,
      subtasks: [],
      isEditing: true,
      isExpanded: false
    };

    const addToNested = (tasks, path) => {
      if (path.length === 0) {
        return [...tasks, newTask];
      }
      return tasks.map((task, i) => 
        i === path[0]
          ? { ...task, subtasks: addToNested(task.subtasks, path.slice(1)), isExpanded: true }
          : task
      );
    };

    updateCurrentList(addToNested(list.tasks, parentPath));
  };

  const updateTask = (path, updates) => {
    const list = getCurrentList();
    if (!list) return;

    const updateNested = (tasks, p) => {
      if (p.length === 1) {
        return tasks.map((task, i) => 
          i === p[0] ? { ...task, ...updates } : task
        );
      }
      return tasks.map((task, i) => 
        i === p[0]
          ? { ...task, subtasks: updateNested(task.subtasks, p.slice(1)) }
          : task
      );
    };

    updateCurrentList(updateNested(list.tasks, path));

    if (updates.completed === true) {
      showCelebration();
    }
  };

  const deleteTask = (path) => {
    const list = getCurrentList();
    if (!list) return;

    const deleteNested = (tasks, p) => {
      if (p.length === 1) {
        return tasks.filter((_, i) => i !== p[0]);
      }
      return tasks.map((task, i) => 
        i === p[0]
          ? { ...task, subtasks: deleteNested(task.subtasks, p.slice(1)) }
          : task
      );
    };

    updateCurrentList(deleteNested(list.tasks, path));
  };

  const getProgress = (task) => {
    const count = (t) => {
      const self = t.completed ? 1 : 0;
      const children = t.subtasks.reduce((sum, st) => sum + count(st).completed, 0);
      const total = 1 + t.subtasks.reduce((sum, st) => sum + count(st).total, 0);
      return { completed: self + children, total };
    };
    return count(task);
  };

  const TaskItem = ({ task, path }) => {
    const progress = getProgress(task);
    const hasSubtasks = task.subtasks.length > 0;
    const shouldShow = showCompleted || !task.completed;

    if (!shouldShow) return null;

    return (
      <div className="task-item">
        <div className="task-row">
          <div className="task-left">
            {hasSubtasks && (
              <button
                className="expand-btn"
                onClick={() => updateTask(path, { isExpanded: !task.isExpanded })}
              >
                {task.isExpanded ? <ChevronDown size={16} /> : <ChevronRight size={16} />}
              </button>
            )}
            <button
              className={`checkbox ${task.completed ? 'checked' : ''}`}
              onClick={() => updateTask(path, { completed: !task.completed })}
            >
              {task.completed && <Check size={14} />}
            </button>
            {task.isEditing ? (
              <input
                type="text"
                value={task.text}
                onChange={(e) => updateTask(path, { text: e.target.value })}
                onBlur={() => updateTask(path, { isEditing: false })}
                onKeyPress={(e) => {
                  if (e.key === 'Enter') {
                    updateTask(path, { isEditing: false });
                  }
                }}
                autoFocus
                className="task-input"
                placeholder="Enter task..."
              />
            ) : (
              <span
                className={`task-text ${task.completed ? 'completed' : ''}`}
                onClick={() => updateTask(path, { isEditing: true })}
              >
                {task.text || 'Untitled task'}
              </span>
            )}
          </div>
          <div className="task-right">
            {hasSubtasks && (
              <span className="progress-badge">
                {progress.completed}/{progress.total}
              </span>
            )}
            <button
              className="icon-btn add-btn"
              onClick={() => addTask(path)}
              title="Add subtask"
            >
              <Plus size={16} />
            </button>
            <button
              className="icon-btn delete-btn"
              onClick={() => deleteTask(path)}
              title="Delete task"
            >
              <Trash2 size={16} />
            </button>
          </div>
        </div>
        {task.isExpanded && hasSubtasks && (
          <div className="subtasks">
            {task.subtasks.map((subtask, i) => (
              <TaskItem key={subtask.id} task={subtask} path={[...path, i]} />
            ))}
          </div>
        )}
      </div>
    );
  };

  if (currentListId === null) {
    return (
      <div className="app-container">
        <div className="home-view">
          <h1 className="app-title">Catherine's To-Do Lists</h1>
          <div className="new-list-section">
            <input
              type="text"
              value={newListName}
              onChange={(e) => setNewListName(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && createList()}
              placeholder="New list name..."
              className="new-list-input"
            />
            <button onClick={createList} className="create-list-btn">
              <Plus size={20} /> Create List
            </button>
          </div>
          <div className="lists-grid">
            {lists.map(list => (
              <div key={list.id} className="list-card">
                <h3>{list.name}</h3>
                <p>{list.tasks.length} tasks</p>
                <div className="list-card-actions">
                  <button onClick={() => setCurrentListId(list.id)} className="open-btn">
                    Open
                  </button>
                  <button onClick={() => deleteList(list.id)} className="delete-list-btn">
                    <Trash2 size={16} />
                  </button>
                </div>
              </div>
            ))}
          </div>
        </div>
        <style>{styles}</style>
      </div>
    );
  }

  const currentList = getCurrentList();

  return (
    <div className="app-container">
      <div className="header">
        <div className="header-top">
          <button onClick={() => setCurrentListId(null)} className="home-btn">
            <Home size={20} /> Home
          </button>
          <h1 className="list-title">{currentList?.name}</h1>
        </div>
        <div className="controls">
          <button
            onClick={() => setShowCompleted(!showCompleted)}
            className="toggle-btn"
          >
            {showCompleted ? <Eye size={18} /> : <EyeOff size={18} />}
            {showCompleted ? 'Hide' : 'Show'} Completed
          </button>
          <button onClick={() => addTask()} className="add-task-btn">
            <Plus size={18} /> Add Task
          </button>
        </div>
      </div>

      <div className="tasks-container">
        {currentList?.tasks.map((task, i) => (
          <TaskItem key={task.id} task={task} path={[i]} />
        ))}
        {currentList?.tasks.length === 0 && (
          <div className="empty-state">
            <p>No tasks yet. Click "Add Task" to get started!</p>
          </div>
        )}
      </div>

      {celebration && (
        <div className="celebration">
          {celebration}
        </div>
      )}

      <style>{styles}</style>
    </div>
  );
};

const styles = `
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  .app-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 25%, #e1f5dd 50%, #c8e6c9 75%, #fce4ec 100%);
    background-size: 400% 400%;
    animation: floral-gradient 15s ease infinite;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 20px;
  }

  @keyframes floral-gradient {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  .app-container::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
      radial-gradient(circle at 20% 30%, rgba(233, 30, 99, 0.08) 0%, transparent 50%),
      radial-gradient(circle at 80% 70%, rgba(76, 175, 80, 0.08) 0%, transparent 50%),
      radial-gradient(circle at 40% 80%, rgba(244, 143, 177, 0.08) 0%, transparent 50%);
    pointer-events: none;
  }

  .home-view {
    max-width: 800px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }

  .app-title {
    text-align: center;
    font-size: 2.5rem;
    color: #c2185b;
    margin-bottom: 2rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    font-weight: 600;
  }

  .new-list-section {
    display: flex;
    gap: 10px;
    margin-bottom: 2rem;
    background: white;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(194, 24, 91, 0.15);
  }

  .new-list-input {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid #f48fb1;
    border-radius: 8px;
    font-size: 1rem;
    outline: none;
    transition: border-color 0.3s;
  }

  .new-list-input:focus {
    border-color: #c2185b;
  }

  .create-list-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: linear-gradient(135deg, #e91e63, #c2185b);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: transform 0.2s;
  }

  .create-list-btn:hover {
    transform: translateY(-2px);
  }

  .lists-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
  }

  .list-card {
    background: white;
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(194, 24, 91, 0.15);
    transition: transform 0.2s;
  }

  .list-card:hover {
    transform: translateY(-4px);
  }

  .list-card h3 {
    color: #c2185b;
    margin-bottom: 8px;
    font-size: 1.3rem;
  }

  .list-card p {
    color: #666;
    margin-bottom: 16px;
  }

  .list-card-actions {
    display: flex;
    gap: 10px;
  }

  .open-btn {
    flex: 1;
    padding: 10px;
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: transform 0.2s;
  }

  .open-btn:hover {
    transform: scale(1.05);
  }

  .delete-list-btn {
    padding: 10px;
    background: #ffebee;
    color: #c2185b;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .delete-list-btn:hover {
    background: #ffcdd2;
  }

  .header {
    max-width: 800px;
    margin: 0 auto 2rem;
    position: relative;
    z-index: 1;
  }

  .header-top {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 1rem;
  }

  .home-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: white;
    color: #c2185b;
    border: 2px solid #f48fb1;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
  }

  .home-btn:hover {
    background: #fce4ec;
  }

  .list-title {
    flex: 1;
    font-size: 2rem;
    color: #c2185b;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
  }

  .controls {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }

  .toggle-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: white;
    color: #4caf50;
    border: 2px solid #a5d6a7;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
  }

  .toggle-btn:hover {
    background: #e8f5e9;
  }

  .add-task-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: linear-gradient(135deg, #e91e63, #c2185b);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: transform 0.2s;
  }

  .add-task-btn:hover {
    transform: translateY(-2px);
  }

  .tasks-container {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 16px rgba(194, 24, 91, 0.15);
    position: relative;
    z-index: 1;
  }

  .task-item {
    margin-bottom: 8px;
  }

  .task-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    background: #fafafa;
    border-radius: 8px;
    transition: background 0.2s;
  }

  .task-row:hover {
    background: #f5f5f5;
  }

  .task-left {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
  }

  .expand-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: #666;
    padding: 4px;
    display: flex;
    align-items: center;
    transition: color 0.2s;
  }

  .expand-btn:hover {
    color: #c2185b;
  }

  .checkbox {
    width: 24px;
    height: 24px;
    border: 2px solid #f48fb1;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
  }

  .checkbox:hover {
    border-color: #c2185b;
  }

  .checkbox.checked {
    background: linear-gradient(135deg, #e91e63, #c2185b);
    border-color: #c2185b;
    color: white;
  }

  .task-input {
    flex: 1;
    border: none;
    background: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 1rem;
    outline: none;
    border: 2px solid #f48fb1;
  }

  .task-input:focus {
    border-color: #c2185b;
  }

  .task-text {
    flex: 1;
    cursor: pointer;
    color: #333;
    font-size: 1rem;
    transition: color 0.2s;
  }

  .task-text:hover {
    color: #c2185b;
  }

  .task-text.completed {
    text-decoration: line-through;
    color: #999;
  }

  .task-right {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .progress-badge {
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 500;
  }

  .icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 6px;
    border-radius: 6px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
  }

  .add-btn {
    color: #4caf50;
  }

  .add-btn:hover {
    background: #e8f5e9;
  }

  .delete-btn {
    color: #e91e63;
  }

  .delete-btn:hover {
    background: #fce4ec;
  }

  .subtasks {
    margin-left: 40px;
    margin-top: 8px;
    border-left: 2px solid #f48fb1;
    padding-left: 16px;
  }

  .empty-state {
    text-align: center;
    padding: 40px;
    color: #999;
    font-size: 1.1rem;
  }

  .celebration {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #e91e63, #c2185b);
    color: white;
    padding: 24px 40px;
    border-radius: 16px;
    font-size: 1.5rem;
    font-weight: 600;
    box-shadow: 0 8px 24px rgba(194, 24, 91, 0.4);
    animation: celebrate 0.5s ease;
    z-index: 1000;
  }

  @keyframes celebrate {
    0% {
      transform: translate(-50%, -50%) scale(0.8);
      opacity: 0;
    }
    50% {
      transform: translate(-50%, -50%) scale(1.1);
    }
    100% {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
  }
`;

export default TodoApp;
